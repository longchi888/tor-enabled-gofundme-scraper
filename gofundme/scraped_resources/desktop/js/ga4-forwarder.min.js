"use strict";window.GA4mParticleForwarder=function(){var t={Denied:"denied",Granted:"granted"},e=["ad_storage","ad_user_data","ad_personalization","analytics_storage"];function n(t){this.common=t||{}}n.prototype.getUserConsentState=function(){var t={};if(mParticle.Identity&&mParticle.Identity.getCurrentUser){if(!mParticle.Identity.getCurrentUser())return{};var e=mParticle.Identity.getCurrentUser().getConsentState();e&&e.getGDPRConsentState&&(t=e.getGDPRConsentState())}return t},n.prototype.getEventConsentState=function(t){return t&&t.getGDPRConsentState?t.getGDPRConsentState():{}},n.prototype.getConsentSettings=function(){var e={},n={ad_user_data:"defaultAdUserDataConsentSDK",ad_personalization:"defaultAdPersonalizationConsentSDK",ad_storage:"defaultAdStorageConsentSDK",analytics_storage:"defaultAnalyticsStorageConsentSDK"},r=this.common.forwarderSettings;return Object.keys(n).forEach((function(o){var i=n[o],a=r[i];a&&i&&(e[o]=t[a])})),e},n.prototype.generateConsentStatePayloadFromMappings=function(n,r){if(!r)return{};for(var o=this.common.cloneObject(this.common.consentPayloadDefaults),i=0;i<=r.length-1;i++){var a=r[i],s=a.map.toLowerCase(),c=a.value;n[s]&&-1!==e.indexOf(c)&&(o[c]=n[s].Consented?t.Granted:t.Denied)}return o};var r=n,o={page_title:300,page_referrer:420,page_location:1e3,page_url:1e3},i=["item_category","item_category2","item_category3","item_category4","item_category5"],a=["google_","firebase_","ga_"],s=/[^a-zA-Z0-9_]/g;function c(t,e){return t&&t.length>e?t.substring(0,e):t}function u(t){return null==t||!(Object.keys(t)||t).length}function d(){this.consentMappings=[],this.consentPayloadDefaults={},this.consentPayloadAsString="",this.consentHandler=new r(this)}d.prototype.forwarderSettings=null,d.prototype.mergeObjects=function(){for(var t={},e=0;e<arguments.length;e+=1)for(var n=arguments[e],r=Object.keys(n),o=0;o<r.length;o+=1)t[r[o]]=n[r[o]];return t},d.prototype.truncateAttributes=function(t,e,n){var r={};return u(t)||Object.keys(t).forEach((function(i){var a=c(i,e),s=o[i]||n,u=c(t[i],s);r[a]=u})),r},d.prototype.limitAttributes=function(t,e){if(u(t))return{};var n=Object.keys(t);return n.sort(),n.slice(0,e).reduce((function(e,n){return e[n]=t[n],e}),{})},d.prototype.limitEventAttributes=function(t){return this.limitAttributes(t,100)},d.prototype.limitProductAttributes=function(t){var e={},n={};for(var r in t)i.indexOf(r)>=0?n[r]=t[r]:e[r]=t[r];var o=this.limitAttributes(e,10);return this.mergeObjects(o,n)},d.prototype.truncateEventName=function(t){return c(t,40)},d.prototype.truncateEventAttributes=function(t){return this.truncateAttributes(t,40,100)},d.prototype.standardizeParameters=function(t){var e={};for(var n in t){e[this.standardizeName(n)]=t[n]}return e},d.prototype.standardizeName=function(t){if(window.GoogleAnalytics4Kit.hasOwnProperty("setCustomNameStandardization"))try{t=window.GoogleAnalytics4Kit.setCustomNameStandardization(t)}catch(t){console.warn("Error calling setCustomNameStandardization callback. Check your callback.  Data will still be sent without user-defined standardization. See our docs for proper use - https://docs.mparticle.com/integrations/google-analytics-4/event/",t)}function e(t){return!u(t)&&/^[a-zA-Z]/.test(t.charAt(0))}function n(t){var e=!1;if(!u(t))for(var n=0;n<a.length;n++){var r=a[n];if(0===t.indexOf(r)){e=!0;break}}return e}function r(t){for(var e=t.slice();!u(e)&&e.charAt(0).match(/[^a-zA-Z]/i);)e=e.substring(1);return e}function o(t){var e=t.slice();return a.forEach((function(t){0===e.indexOf(t)&&(e=e.replace(t,""))})),e}for(var i=function(t){return t.replace(s,"_")}(t);!e(i)||n(i);)i=o(i=r(i));return i},d.prototype.truncateUserAttributes=function(t){return this.truncateAttributes(t,24,36)},d.prototype.getUserId=function(t,e,n){if(t){var r,o="None",i="Other",a="Other2",s="Other3",c="Other4",u="Other5",d="Other6",l="Other7",m="Other8",f="Other9",g="Other10",p="mpid",y=t.getUserIdentities().userIdentities;if(e!==o){switch(e){case"CustomerId":r=y.customerid;break;case i:r=y.other;break;case a:r=y.other2;break;case s:r=y.other3;break;case c:r=y.other4;break;case u:r=y.other5;break;case d:r=y.other6;break;case l:r=y.other7;break;case m:r=y.other8;break;case f:r=y.other9;break;case g:r=y.other10;break;case p:r=t.getMPID();break;default:console.warn("External identity type not found for setting identity on GA4. User not set. Please double check your implementation.")}return r?"True"==n&&(r=window.mParticle.generateHash(r)):console.warn("External identity type of "+e+" not set on the user"),r}}},d.prototype.cloneObject=function(t){return JSON.parse(JSON.stringify(t))},d.prototype.isEmpty=u;var l=d,m="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function f(t){m.common=this.common=t||{}}var g=0,p=10,y=14,h=12,v=13,w=22,C=16,A=17,b=11,P=15,E=20,S=19,_=18,I="GA4.CommerceEventType",k="GA4.ShippingTier",O="GA4.PaymentType",T="add_shipping_info",G="add_payment_info",U="view_cart";function D(t){return t.split(/(?=[A-Z])/).join("_").toLowerCase()}function F(t,e){var n=[];return t.forEach((function(t){n.push(function(t,e){var n={};for(var r in e&&(n.affiliation=e),n=m.common.mergeObjects(n,m.common.limitProductAttributes(t.Attributes)),t)switch(r){case"Sku":n.item_id=t.Sku;break;case"Name":n.item_name=t.Name;break;case"Brand":n.item_brand=t.Brand;break;case"Category":n.item_category=t.Category;break;case"CouponCode":n.coupon=t.CouponCode;break;case"Variant":n.item_variant=t.Variant;break;case"Attributes":break;default:n[D(r)]=t[r]}return m.common.forwarderSettings.enableDataCleansing?m.common.standardizeParameters(n):n}(t,e))})),n}function L(t){switch(t.EventCategory){case p:return"add_to_cart";case E:return"add_to_wishlist";case b:return"remove_from_cart";case C:return"purchase";case h:return"begin_checkout";case v:return function(t){switch(t[I]){case T:return T;case G:return G;default:return"set_checkout_option"}}(t.CustomFlags);case y:return"select_item";case w:return"view_item_list";case A:return"refund";case P:return"view_item";case S:return"select_promotion";case _:return"view_promotion";case g:if(t.CustomFlags&&t.CustomFlags[I]===U)return"view_cart";break;default:return console.error("Product Action Type not supported"),null}}f.prototype.logCommerceEvent=function(t){var e=!0,n=!0,r={},o=!1,i=t.EventAttributes||{},a=t&&t.ProductAction?t.ProductAction.Affiliation:null;if(t.EventCategory===g&&t.CustomFlags&&t.CustomFlags[I]===U)return o=!0,this.logViewCart(t,a);if(t.EventCategory===w)return this.logImpressionEvent(t,a);if(t.EventCategory===S||t.EventCategory===_)return this.logPromotionEvent(t);switch(t.EventCategory){case p:case b:r=function(t,e){return{items:F(t.ProductAction.ProductList,e)}}(t,a);break;case h:r=function(t,e){return{items:F(t.ProductAction.ProductList,e),coupon:t.ProductAction?t.ProductAction.CouponCode:null}}(t,a);break;case y:r=function(t,e){return{items:F(t.ProductAction.ProductList,e)}}(t,a),e=!1,n=!1;break;case C:case A:r=function(t,e){return{transaction_id:t.ProductAction.TransactionId,value:t.ProductAction.TotalAmount,coupon:t.ProductAction.CouponCode,shipping:t.ProductAction.ShippingAmount,tax:t.ProductAction.TaxAmount,items:F(t.ProductAction.ProductList,e)}}(t,a);break;case P:r=function(t,e){return{items:F(t.ProductAction.ProductList,e)}}(t,a);break;case E:r=function(t,e){return{value:t.ProductAction.TotalAmount,items:F(t.ProductAction.ProductList,e)}}(t,a);break;case v:return this.logCheckoutOptionEvent(t,a);default:if(!o)return console.error("Unsupported Commerce Event. Event not sent.",t),!1}return this.common.forwarderSettings.enableDataCleansing&&(i=this.common.standardizeParameters(i)),r=this.common.mergeObjects(r,this.common.limitEventAttributes(i)),e&&(r.currency=t.CurrencyCode),n&&(r.value=t.CustomFlags&&t.CustomFlags["GA4.Value"]||t.ProductAction.TotalAmount||null),this.sendCommerceEventToGA4(L(t),r)},f.prototype.sendCommerceEventToGA4=function(t,e){return this.common.forwarderSettings.measurementId&&(e.send_to=this.common.forwarderSettings.measurementId),gtag("event",t,e),!0},f.prototype.logCheckoutOptionEvent=function(t,e){try{var n,r=t.CustomFlags,o=r[I];switch(r&&o||console.error('Your checkout option event for the Google Analytics 4 integration is missing a custom flag for "GA4.CommerceEventType". The event was sent using the deprecated set_checkout_option event.  Review mParticle docs for GA4 for the custom flags to add.'),o){case T:n=function(t,e){return{coupon:t.ProductAction&&t.ProductAction.CouponCode?t.ProductAction.CouponCode:null,shipping_tier:t.CustomFlags&&t.CustomFlags[k]?t.CustomFlags[k]:null,items:F(t.ProductAction.ProductList,e)}}(t,e);break;case G:n=function(t,e){return{coupon:t.ProductAction&&t.ProductAction.CouponCode?t.ProductAction.CouponCode:null,payment_type:t.CustomFlags&&t.CustomFlags[O]?t.CustomFlags[O]:null,items:F(t.ProductAction.ProductList,e)}}(t,e);break;default:n=function(t,e){var n=t.EventAttributes;return n.items=F(t.ProductAction.ProductList,e),n.coupon=t.ProductAction?t.ProductAction.CouponCode:null,n}(t,e)}}catch(t){return console.error("There is an issue with the custom flags in your CheckoutOption event. The event was not sent.  Plrease review the docs and fix.",t),!1}return this.sendCommerceEventToGA4(L(t),n)},f.prototype.logPromotionEvent=function(t){var e=this;try{var n;return t.PromotionAction.PromotionList.forEach((function(r){n=function(t){return function(t){var e={};for(var n in t)switch(n){case"Id":e.promotion_id=t.Id;break;case"Creative":e.creative_name=t.Creative;break;case"Name":e.promotion_name=t.Name;break;case"Position":e.creative_slot=t.Position;break;default:e[D(n)]=t[n]}return m.common.forwarderSettings.enableDataCleansing?m.common.standardizeParameters(e):e}(t)}(r),e.sendCommerceEventToGA4(L(t),n)})),!0}catch(t){return console.error("Error logging Promotions to GA4. Promotions not logged.",t),!1}},f.prototype.logImpressionEvent=function(t,e){var n=this;try{var r;return t.ProductImpressions.forEach((function(o){r=function(t,e){return{item_list_id:t.ProductImpressionList,item_list_name:t.ProductImpressionList,items:F(t.ProductList,e)}}(o,e),n.sendCommerceEventToGA4(L(t),r)})),!0}catch(t){return console.log("Error logging Impressions to GA4. Impressions not logged",t),!1}},f.prototype.logViewCart=function(t,e){var n=function(t,e){return{items:F(t.ProductAction.ProductList,e)}}(t,e);return(n=this.common.mergeObjects(n,this.common.limitEventAttributes(t.EventAttributes))).currency=t.CurrencyCode,n.value=t.CustomFlags&&t.CustomFlags["GA4.Value"]||t.ProductAction.TotalAmount||null,this.sendCommerceEventToGA4(L(t),n)};var z=f;function H(t){this.common=t||{}}H.prototype.maybeSendConsentUpdateToGa4=function(t){if(this.common.consentPayloadAsString&&this.common.consentMappings){var e=this.common.consentHandler.getEventConsentState(t.ConsentState);if(!this.common.isEmpty(e)){var n=this.common.consentHandler.generateConsentStatePayloadFromMappings(e,this.common.consentMappings),r=JSON.stringify(n);r!==this.common.consentPayloadAsString&&(gtag("consent","update",n),this.common.consentPayloadAsString=r)}}},H.prototype.sendEventToGA4=function(t,e){var n,r;this.common.forwarderSettings.enableDataCleansing?(n=this.common.standardizeName(t),r=this.common.standardizeParameters(e)):(n=t,r=e),r=this.common.limitEventAttributes(r),this.common.forwarderSettings.measurementId&&(r.send_to=this.common.forwarderSettings.measurementId),gtag("event",this.common.truncateEventName(n),this.common.truncateEventAttributes(r))},H.prototype.logEvent=function(t){this.maybeSendConsentUpdateToGa4(t),this.sendEventToGA4(t.EventName,t.EventAttributes)},H.prototype.logError=function(){console.warn("Google Analytics 4 does not support error events.")},H.prototype.logPageView=function(t){var e="GA4.Title",n="GA4.Location",r="Google.Title",o="Google.Location",i=location.href,a=document.title;t.CustomFlags&&(t.CustomFlags.hasOwnProperty(e)?a=t.CustomFlags[e]:t.CustomFlags.hasOwnProperty(r)&&(a=t.CustomFlags[r]),t.CustomFlags.hasOwnProperty(n)?i=t.CustomFlags[n]:t.CustomFlags.hasOwnProperty(o)&&(i=t.CustomFlags[o]));var s=this.common.mergeObjects({page_title:a,page_location:i},t.EventAttributes);return this.maybeSendConsentUpdateToGa4(t),this.sendEventToGA4("page_view",s),!0};var N=H;function j(t){this.common=t||{}}j.prototype.onUserIdentified=function(t){var e=this.common.getUserId(t,this.common.forwarderSettings.externalUserIdentityType,this.common.forwarderSettings.hashUserId);gtag("config",this.common.forwarderSettings.measurementId,{send_page_view:!1,user_id:e})},j.prototype.onIdentifyComplete=function(t,e){},j.prototype.onLoginComplete=function(t,e){},j.prototype.onLogoutComplete=function(t,e){},j.prototype.onModifyComplete=function(t,e){},j.prototype.onSetUserIdentity=function(t,e,n){};var M=j,x={name:"GoogleAnalytics4",moduleId:160,initForwarder:function(t,e,n,r,o,i,a,s){mParticle._setIntegrationDelay(this.moduleId,!0),window.GoogleAnalytics4Kit=window.GoogleAnalytics4Kit||{},s.forwarderSettings=t,s.forwarderSettings.enableDataCleansing="True"===s.forwarderSettings.enableDataCleansing;var c,u=t.measurementId,d=t.externalUserIdentityType,l=t.hashUserId,m={send_page_view:"True"===t.enablePageView};if(t.consentMappingSDK?s.consentMappings=(c=t.consentMappingSDK,JSON.parse(c.replace(/&quot;/g,'"'))):(s.consentMappings=[],s.consentPayloadDefaults={},s.consentPayloadAsString=""),window.dataLayer=window.dataLayer||[],window.gtag=function(){window.dataLayer.push(arguments)},gtag("js",new Date),"2"===window.mParticle.getVersion().split(".")[0]){var f=s.getUserId(mParticle.Identity.getCurrentUser(),d,l);f&&(m.user_id=f)}if(gtag("config",u,m),gtag("get",u,"client_id",(function(t){!function(t,e){var n={};n.client_id=t,window.mParticle.setIntegrationAttribute(e,n),window.mParticle._setIntegrationDelay(e,!1)}(t,x.moduleId)})),e)a=!0;else{var g=document.createElement("script");g.type="text/javascript",g.async=!0,g.src="https://www.googletagmanager.com/gtag/js?id="+u,(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(g),g.onload=function(){if(a=!0,window.dataLayer&&gtag&&i.length>0){for(var t=0;t<i.length;t++)o(i[t]);i=[]}}}s.consentPayloadDefaults=s.consentHandler.getConsentSettings();var p=s.consentHandler.getUserConsentState(),y=s.consentHandler.generateConsentStatePayloadFromMappings(p,s.consentMappings);return s.isEmpty(y)||(s.consentPayloadAsString=JSON.stringify(y),gtag("consent","default",y)),a}};var K=x,V={onSessionStart:function(t){},onSessionEnd:function(t){}};function R(t){this.common=t||{}}R.prototype.sendUserPropertiesToGA4=function(t){gtag("set","user_properties",this.common.truncateUserAttributes(t))},R.prototype.onRemoveUserAttribute=function(t){var e={};e[t]=null,this.sendUserPropertiesToGA4(e)},R.prototype.onSetUserAttribute=function(t,e){var n={};n[t]=e,this.sendUserPropertiesToGA4(n)};var J=R,B=K.name,Z=K.moduleId,Y=1,q=2,Q=3,W=4,X=5,$=16,tt=20,et=function(){var t,e,n=this,r=!1,o=[];function i(t){var i=!1;if(!r)return o.push(t),"Can't send to forwarder "+B+", not initialized. Event added to queue.";try{return t.EventDataType===Y?i=function(t){try{return V.onSessionStart(t),!0}catch(t){return{error:"Error starting session on forwarder "+B+"; "+t}}}(t):t.EventDataType===q?i=function(t){try{return V.onSessionEnd(t),!0}catch(t){return{error:"Error ending session on forwarder "+B+"; "+t}}}(t):t.EventDataType===X?i=function(t){try{return n.eventHandler.logError(t),!0}catch(t){return{error:"Error logging error on forwarder "+B+"; "+t}}}(t):t.EventDataType===Q?i=function(t){try{return n.eventHandler.logPageView(t),!0}catch(t){return{error:"Error logging page view on forwarder "+B+"; "+t}}}(t):t.EventDataType===$?i=function(t){try{return n.commerceHandler.logCommerceEvent(t),!0}catch(t){return{error:"Error logging purchase event on forwarder "+B+"; "+t}}}(t):(t.EventDataType===W||t.EventDataType===tt)&&(i=a(t)),!0===i&&e?(e(n,t),"Successfully sent to "+B):"Error logging event or event type not supported on forwarder "+B}catch(t){return"Failed to send to "+B+" "+t}}function a(t){try{return n.eventHandler.logEvent(t),!0}catch(t){return{error:"Error logging event on forwarder "+B+"; "+t}}}n.name=K.name,n.moduleId=K.moduleId,n.common=new l,this.init=function(a,s,c,u,d,l,m,f,g,p){t=a,e="undefined"!=typeof window&&window.mParticle.isTestEnvironment?function(){}:s;try{K.initForwarder(a,c,d,l,i,o,r,n.common,m,f,g,p),n.eventHandler=new N(n.common),n.identityHandler=new M(n.common),n.userAttributeHandler=new J(n.common),n.commerceHandler=new z(n.common),r=!0}catch(t){console.log("Failed to initialize "+B+" - "+t)}},this.process=i,this.setUserAttribute=function(e,o){if(!r)return"Can't set user attribute on forwarder "+B+", not initialized";try{return n.userAttributeHandler.onSetUserAttribute(e,o,t),"Successfully set user attribute on forwarder "+B}catch(t){return"Error setting user attribute on forwarder "+B+"; "+t}},this.removeUserAttribute=function(e){if(!r)return"Can't remove user attribute on forwarder "+B+", not initialized";try{return n.userAttributeHandler.onRemoveUserAttribute(e,t),"Successfully removed user attribute on forwarder "+B}catch(t){return"Error removing user attribute on forwarder "+B+"; "+t}},this.onUserIdentified=function(t){if(!r)return"Can't set new user identities on forwader  "+B+", not initialized";try{return n.identityHandler.onUserIdentified(t),"Successfully called onUserIdentified on forwarder "+B}catch(t){return{error:"Error calling onUserIdentified on forwarder "+B+"; "+t}}},this.setUserIdentity=function(e,o){if(!r)return"Can't call setUserIdentity on forwarder "+B+", not initialized";try{return n.identityHandler.onSetUserIdentity(t,e,o),"Successfully set user Identity on forwarder "+B}catch(t){return"Error removing user attribute on forwarder "+B+"; "+t}},this.onIdentifyComplete=function(t,e){if(!r)return"Can't call onIdentifyCompleted on forwader  "+B+", not initialized";try{return n.identityHandler.onIdentifyComplete(t,e),"Successfully called onIdentifyComplete on forwarder "+B}catch(t){return{error:"Error calling onIdentifyComplete on forwarder "+B+"; "+t}}},this.onLoginComplete=function(t,e){if(!r)return"Can't call onLoginComplete on forwader  "+B+", not initialized";try{return n.identityHandler.onLoginComplete(t,e),"Successfully called onLoginComplete on forwarder "+B}catch(t){return{error:"Error calling onLoginComplete on forwarder "+B+"; "+t}}},this.onLogoutComplete=function(t,e){if(!r)return"Can't call onLogoutComplete on forwader  "+B+", not initialized";try{return n.identityHandler.onLogoutComplete(t,e),"Successfully called onLogoutComplete on forwarder "+B}catch(t){return{error:"Error calling onLogoutComplete on forwarder "+B+"; "+t}}},this.onModifyComplete=function(t,e){if(!r)return"Can't call onModifyComplete on forwader  "+B+", not initialized";try{return n.identityHandler.onModifyComplete(t,e),"Successfully called onModifyComplete on forwarder "+B}catch(t){return{error:"Error calling onModifyComplete on forwarder "+B+"; "+t}}},this.setOptOut=function(t){if(!r)return"Can't call setOptOut on forwader  "+B+", not initialized";try{return n.initialization.setOptOut(t),"Successfully called setOptOut on forwarder "+B}catch(t){return{error:"Error calling setOptOut on forwarder "+B+"; "+t}}}};function nt(t){return null!=t&&"object"==typeof t&&!1===Array.isArray(t)}return"undefined"!=typeof window&&window&&window.mParticle&&window.mParticle.addForwarder&&window.mParticle.addForwarder({name:B,constructor:et,getId:function(){return Z}}),{register:function(t){t?nt(t)?(nt(t.kits)||(t.kits={}),t.kits[B]={constructor:et},console.log("Successfully registered "+B+" to your mParticle configuration")):console.log("'config' must be an object. You passed in a "+typeof t):console.log("You must pass a config object to register the kit "+B)}}}();
